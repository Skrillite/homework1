# Отправка отчета о поездке на почту в приложении Яндекс Go

## Цель

Дать пользователю всю релевантную информацию о его поездке в наглядном и удобном виде, доступную с любого устройства.  
Такие отчеты пользователь может использовать для последующего анализа своих поездок, представления работодателю, связи с поддержкой в случае возникновения каких-либо проблем после поездки и невозможности зайти в приложение. Потенциально может помогать людям с провалами в памяти.

## Описание задачи

Реализовать возможность отправки на почту пользователя отчета о совершенной поездке после её завершения. Необходимый функционал:

- возможность добавить новый адрес электронной почты / изменить текущий;
- валидация адреса электронной почты (как при первичном добавлении, так и изменении);
- формирование и отправка отчетов;
- возможность запроса повторного отчета о прошедшей поездке;
- формирование отчета о прошлых поездках за период сотрудником технической поддержки.

## Оценка результативности

### Предположения

- наличие отчетов о поездке может увеличить число пользователей сервиса, которым была необходима такая функция;
- по схожей схеме могут формироваться агрегированные отчеты для водителей.

### Метрики

- увеличение числа поездок среди пользователей, которым доступна функция. При этом, можно анализировать изменение числа рабочих поездок (из дома на работу и обратно, в других городах из/в гостиницу);
- количество просмотров отчетов о поездке (наиболее релевантно для MVP);
- темпы роста числа пользовательских профилей, к которым будет добавлен адрес электронной почты;
- техническая метрика: нагрузка на почтовый сервер;
- техническая метрика: нагрузка на сервер при генерации отчетов.

## MVP

Отчет о поездке представляет собой уже существующие данные, которые необходимо сгруппировать и сделать доступными для пользователя. Таким образом, для проверки целесообразности отчета можно сделать его доступным по нажатию на кнопку (или саму поездку) в истории заказов. Также необходимо проинформировать пользователя о появлении нового функционала.

### Реализация MVP

1. Определение набора атрибутов отчета.  
   Предлагается использовать следующие данные о поездке:
   - начальная и конечная точки;
   - время начала и окончания поездки;
   - продолжительность поездки (вычисляемое значение);
   - дата поездки;
   - стоимость поездки;
   - способ оплаты;
   - тариф;
   - ФИО водителя;
   - государственный номер автомобиля;
   - марка автомобиля.
2. Выбор микросервиса.  
   Большая часть необходимых данных связана с поездкой, поэтому endpoint, который будет передавать данные отчета, целесообразно реализовать на микросервисе, отвечающим за поездки. Информацию о водителе и автомобиле необходимо забирать из соответствующих микросервисов (_drivers_ и _vehicles_).
   На этом этапе необходимо реализовать 3 endpoint'а (описаны в [openapi.yaml](./openapi.yaml)):
   - /driver;
   - /vechicle;
   - /ride-report.
3. Схема запросов:

   ![schema](./mvp_schema.png 'MVP Requests Schema')

4. Потребуются следующие доработки клиентского приложения:

   - верстка формы отчета;
   - возможность открытия отчета из истории поездок;
   - кнопка для открытия отчета после завершения и оценки поездки;
   - уведомление для пользователя при запуске приложения о появлении нового функционала.

5. Определить группу пользователей, которым будет доступен функционал.  
   Предлагается выбрать пользователей, которые в среднем совершают 5 и более поездок в неделю, чтобы оценить их интерес к новой функции, а также тех, кто совершает 1-2 поездки в неделю (преимущественно рабочих) для проверки, не изменится ли количество их заказов.

6. Провести интеграционное тестирование, показывающее, что все данные передаются верно и корректно обрабатываются запросы для несуществующих поездок / водителей / автомобилей, а также что отчет не формируется для незавершенных поездок.  
   Пользовательское тестирование клиентской части приложения.

## Основная реализация

Если использование клиентами MVP функционала докажет его целесообразность, необходима дальнейшая разработка добавления и изменения адреса электронной почты, автоматическая отправка отчета на него по итогам поездки и возможность выгрузки отчета по всем поездкам пользователя за период из приложения поддержки. Подразумевается, что в системе уже реализован функционал асинхронного event listener, который позволяет запускать сервисы при изменении состояния.

Дополнительно к MVP требуется разработка следующих endpoint'ов (описаны в [openapi.yaml](./openapi.yaml)):

- /ride-report/{user_id}.
- /email/{user_id};

### Отчеты по всем поездкам
Для выгрузки всех отчетов о завершенных поездках за период необходимо реализовать endpoint `/ride-report/{user_id}`, который в теле запроса получает начальную и конечную дату для формирования отчета. Соответственно, в приложении поддержки потребуется реализация запросов с данными о пользователе и периоде на этот endpoint.

### Подтверждение почты
Когда на _/email/{user_id}_ приходит новый адрес электронной почтв, то по умолчанию в таблице с данными пользователя напротив неё устанавливается атрибут `verified = false`. Появление в таблице записи с неподтвержденной почтой запускает отдельный сервис по отправке кода верификации и ожидании ответа от пользователя. После подтверждения пользователем адреса почты на endpoint приходит информация о подтверждении почты, атрибут _verified_ меняет значение на _true_.  
После этого для ранее подтвержденного адреса электронной почты (если такой имеется) проставляется признак _archived_.

### Отправка отчета
Вероятнее всего, между клиентским приложением и конечными точками есть промежуточное приложение, на которое направляется информация о завершении поездки. После получения этой информации делается запрос на `/ride-report` для получения данных отчета, которые триггерят отправку письма. В почтовом сервисе будет необходим признак успешной отправки письма, чтобы отслеживать неотправленные и не отправить одно письмо дважды.

## Тестирования

1. Юнит-тесты:

   - добавление нового адреса;
   - изменение существующего адреса;
   - проверка корректности формата и данных отчета;
   - доступность отчета только после завершения поездки;
   - отправка отчета на почту пользователя;
   - формирование отчета за заданный период.

2. Интеграционные тесты между микросервисами. Например:

   - после завершения поездки запрашивается и отдается отчет о поездке;
   - после формирования отчета формируется запрос на отправку письма пользователю;
   - изменение почты триггерит отправку кода для валидации.

3. Пользовательское тестирование.

Нагрузочное тестирование для этого функционала выглядит нецелесообразным с учетом его стоимости и трудоемкости.

## Развертывание функционала

1. На команду.
2. На выбранную тестовую группу разнородных пользователей (например, отобранную для MVP).
3. Поэтапно на всех пользователей приложения.
