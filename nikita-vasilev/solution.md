## Рейтинг пассажиров

Водитель оценивает пассажира. Пассажир имеет возможность увидеть свой текущий рейтинг.
Введя рейтинг для пассажиром мы, возможно, сможем улучшить качество такси для водителей. 
Пассажиры, стараясь улучшить свой рейтинг, будут более пунктуальнее, ставить более удобные точки и т.д.
Также это поможет нам анализировать какие критерии не нравятся водителем, для дальшейшего улучшения сервиса.

### Формула рейтинга

Возьмем средневзвешенное из последних 40 оценок. 
Недавние оценки имеют больше веса, чем старые.

Будем брать последние 40 оценок, сортировать их по свежести и нумеровать от 1 до 40.

![Formula](assets/formula.png)

`xi` - оценка водителя  
`wi` - вес (чем свежее оценка, тем выше вес)

### MVP

Сделаем MVP на Python и Postgres, развернутый на одной машине.

![MVP](assets/mvp.jpg)

При получении нового рейтинга от водителя будем:
- брать последние 40 оценок (захардкодим этот параметр в коде)
- динамически генерировать веса (через оконную ф-ю `row_number`)
- пересчитывать рейтинг на стороне приложения и сохранять в базу

Т.к водитель может проставлять рейтинг позже поездки, может быть ситуация когда за старую поезду рейтинг ставится позже, чем за более свежую.    
todo: sequence diagram

Для разрешения этой ситуации будем сортировать по полю `completed_at` - время выполнения заказа, которое нам будет отсылать клиентское приложение.

Сделаем 2 ручки:
- добавление рейтинга водителем
- получение рейтинга пассажира  

todo: openapi
  
Схема базы:  
![DB Schema](assets/mvp_dp_schema.jpg)

Также, водители могут отсылать рейтинг одновременно, создав тем самым конкурентные запросы.
Воспользуемся пессимистичной блокировкой по строке таблицы `passanger_ratings`.   
todo: sequence diagram

### Полноценный вариант
Для того, чтобы подготовить наш сервис к нагрузке, добавим балансировщики (Load Balancer, LB) и размажем нагрузку в несколько инстансов (контейнеров).
Для выбора кол-ва инстансов проведем нагрузочное тестирование.

В качесве базы перейдем на MongoDB, т.к у нас:
- по результатам MVP получилась не реляционная структура
- проще масштабируется

![DB Schema](assets/service.jpg)

### Бизнеc метрики
- Сколько водителей делают оценки?
- Корреляция принятие пассажира с хорошим/плохим рейтингом водителем
